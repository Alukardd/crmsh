<script version="2.2">
  <shortdesc>NFS Server</shortdesc>
  <longdesc>
    Configure an NFS server. Requires an existing filesystem resource,
    for example a filesystem running on LVM on DRBD.
  </longdesc>
  <category>Basic</category>
  <include>
    <agent type="ocf:heartbeat:exportfs" name="rootfs">
      <require name="id"/>
      <shortdesc>NFSv4 Virtual File System root</shortdesc>
      <override name="id" value="exportfs-root"/>
      <override name="fsid" value="0"/>
      <override name="directory" value="/srv/nfs"/>
      <override name="options" value="rw,crossmnt"/>
    </agent>
    <agent type="ocf:heartbeat:IPaddr2" name="virtual-ip" optional="true">
      <shortdesc>Configure a Virtual IP address used to access the NFS mounts</shortdesc>
      <require name="id"/>
      <require name="ip"/>
    </agent>
    <agent type="ocf:heartbeat:exportfs" name="exportfs">
      <require name="id"/>
      <shortdesc>Exported NFS mount point</shortdesc>
      <override name="id" value="exportfs"/>
      <override name="directory" value="/srv/nfs/example"/>
      <override name="options" value="rw,mountpoint"/>
      <override name="wait_for_leasetime_on_stop" value="true"/>
    </agent>
    <agent type="ocf:heartbeat:Filesystem" name="filesystem">
      <require name="id"/>
    </agent>
  </include>
  <parameters>
    <parameter name="install" type="option" default="true">
      <shortdesc>Disable if no installation should be performed</shortdesc>
      <longdesc>Requires root access if enabled</longdesc>
    </parameter>
    <parameter name="filesystem" type="resource">
      <shortdesc>An existing filesystem resource</shortdesc>
    </parameter>
  </parameters>
  <steps>
    <step type="call">
      <shortdesc>Verify filesystem device</shortdesc>
      <error>Invalid filesystem device: {{filesystem:device}}</error>
      <nodes>all</nodes>
      <if>filesystem</if>
      test -b {{filesystem:device}}
    </step>
    <step type="install">
      <if>install</if>
      nfs-client
      nfs-kernel-server
    </step>
    <step type="cib">
        {{filesystem}}
        {{exportfs}}
        {{rootfs}}
        {{virtual-ip}}
        clone c-{{rootfs:id}} {{rootfs:id}}
        group g-nfs
          {{exportfs:id}}
          {{virtual-ip:id}}
        order base-then-nfs inf: {{filesystem:id}} g-nfs
        colocation nfs-with-base inf: g-nfs {{filesystem:id}}
        order rootfs-before-nfs inf: c-{{rootfs:id}} g-nfs:start
        colocation nfs-with-rootfs inf: g-nfs c-{{rootfs:id}}      
    </step>
    <step type="call">
      <shortdesc>Verify NFS Exports</shortdesc>
      <nodes>all</nodes>
      <if>install</if>
      exportfs -v
    </step>
  </steps>
</script>
