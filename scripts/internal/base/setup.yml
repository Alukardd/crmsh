---
- name: Basic HA cluster configuration
  description: >
    Executing this script will install and configure all prerequisites
    for a Pacemaker-based HA cluster.

    NOTE: Currently, this installation script is only adapted for use on
    SUSE-based distributions. Patches to make it work on other
    distributions are more than welcome.
  parameters:
    - name: nodes
      required: true
    - name: check
      description: Dry run of the configuration
      required: false
    - name: cluster_packages
      default: ntp, corosync, pacemaker, resource-agents, crmsh
    - name: cluster_services
      default: ntp, corosync, pacemaker
    - name: ntpserver
      default: pool.ntp.org
    - name: corosync_bindnetaddr
      required: true
    - name: corosync_mcastaddr
      required: true
    - name: corosync_mcastport
      default: 5405
    - name: corosync_expected_votes
      default: 1
    - name: corosync_mode
      description: Set to mcast for multicast.
      default: udpu
    - name: corosync_auth
      default: false
      description: Create authentication key using corosync-keygen.

  steps:
    - name: Ensure required packages are installed
      action: package name=%(item)s state=present
      with_items: cluster_packages

    - name: Create corosync log directory
      mkdir: /var/log/cluster

    - name: Install corosync key
      copy: src=/etc/corosync/authkey dest=/etc/corosync/authkey mode=400
      when: corosync_auth

    - name: Configure corosync
      template: src=files/corosync.conf.j2 dest=/etc/corosync/corosync.conf backup=yes
      notify: restart corosync

    - name: Ensure cluster services are running
      service: name=%(item)s enabled=yes state=running
      with_items: cluster_services

  handlers:
    - name: restart ntp
      service: name=ntp state=restarted

    - name: restart corosync
      service: name=corosync state=restarted

    - name: reload corosync configuration
      command: corosync-cfgtool -R

