# Copyright (C) 2009 Dejan Muhamedagic
# Copyright (C) 2015 Kristoffer Gronlund
#
# License: GNU General Public License (GPL)
---
- version: 2.2
  shortdesc: Apache Webserver
  longdesc: >
    Configure a resource group containing a virtual IP address and
    an instance of the Apache web server. You can optionally configure
    a Filesystem resource which will be mounted before the web server
    is started. You can also optionally configure a database resource
    which will be started before the web server but after mounting the
    optional filesystem.
  category: Server
  include:
    - agent: ocf:heartbeat:apache
      name: apache
      longdesc: >
        The Apache configuration file specified here must be available via the
        same path on all cluster nodes, and Apache must be configured with
        mod_status enabled.  If in doubt, try running Apache manually via
        its init script first, and ensure http://localhost:80/server-status is
        accessible.
    - script: virtual-ip
      longdesc: The IP address configured here will start before the Apache instance.
    - script: filesystem
      longdesc: Optional filesystem mounted before the web server is started.
      required: false
    - script: database
      shortdesc: Optional database started before the web server is started.
      required: false
  parameters:
    - name: id
      shortdesc: ID for the web server resource group
      example: web-server
      type: resource-id
    - name: configfile
      from: apache
    - name: options
      from: apache
      required: false
    - name: envfiles
      from: apache
      required: false
    - name: install
      type: boolean
      shortdesc: Install and configure apache
      default: true
  actions:
    - install:
        - apache2
      shortdesc: Install the apache package
      when: install
    - service:
        - apache: disable
      shortdesc: Let cluster manage apache
      when: install
    - call: a2enmod status
      shortdesc: Enable status module
      when: install
    - cib: |
        {{filesystem}}
        {{database}}
        {{virtual-ip}}
        primitive p-{{id}} ocf:heartbeat:apache
          params
          configfile="{{configfile}}"
          {{#options}}options="{{options}}"{{/options}}
          {{#envfiles}}envfiles="{{envfiles}}"{{/envfiles}}
          op start timeout="40"
          op stop timeout="60"
          op monitor interval="10" timeout="20"
        group g-{{id}}
          {{filesystem:id}}
          {{database:id}}
          {{virtual-ip:id}}
          p-{{id}}
