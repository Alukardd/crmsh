---
- name: NFS Server
  description: >
    Configure an NFS server. Requires an existing filesystem resource,
    for example a filesystem running on LVM on DRBD.
  category: Basic
  include:
    - agent: ocf:heartbeat:exportfs
      name: rootfs
      require: [id]
      shortdesc: NFSv4 Virtual File System root
      override:
        - id: exportfs-root
        - fsid: 0
        - directory: /srv/nfs
        - options: rw,crossmnt
    - agent: ocf:heartbeat:IPaddr2
      name: virtual-ip
      shortdesc: Configure a Virtual IP address used to access the NFS mounts
      require: [id, ip]
      optional: true
    - agent: ocf:heartbeat:exportfs
      name: exportfs
      require: [id]
      shortdesc: Exported NFS mount point
      override:
        - id: exportfs
          directory: /srv/nfs/example
          options: rw,mountpoint
          wait_for_leasetime_on_stop: true    
    - agent: ocf:heartbeat:Filesystem
      name: filesystem
      require: [id]
  parameters:
    - name: install
      type: boolean
      default: true
      shortdesc: Disable if no installation should be performed
      longdesc: Requires root access if enabled
    - name: filesystem
      type: resource
      description: An existing filesystem resource
  steps:
    - call: "test -b {{filesystem:device}}"
      shortdesc: Verify filesystem device
      error: "Invalid filesystem device {{filesystem:device}}"
      nodes: all
      if: filesystem
    - install:
        - nfs-client
        - nfs-kernel-server
      when: install
    - service: nfsserver
      action: [enable, start]
      nodes: all
      if: install
    - cib: |
        {{filesystem}}
        {{exportfs}}
        {{rootfs}}
        {{virtual-ip}}
        clone c-{{rootfs:id}} {{rootfs:id}}
        group g-nfs
          {{exportfs:id}}
          {{virtual-ip:id}}
        order base-then-nfs inf: {{filesystem:id}} g-nfs
        colocation nfs-with-base inf: g-nfs {{filesystem:id}}
        order rootfs-before-nfs inf: c-{{rootfs:id}} g-nfs:start
        colocation nfs-with-rootfs inf: g-nfs c-{{rootfs:id}}
    - call: exportfs -v
      shortdesc: Verify NFS exports
      nodes: all
      if: install
