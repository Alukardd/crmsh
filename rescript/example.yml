---
- version: 2.2
  shortdesc: Initialize a new cluster
  longdesc: >-
    Initializes a new cluster on the nodes provided. Will try to 
    configure SSH if not already configured, and install missing 
    packages.

    A more user-friendly interface to this script is provided by the 
    cluster init command.
  parameters:
    - name: iface
      shortdesc: Network interface to use.
      longdesc: Tries to auto-detect interface by default.
      default: ""
      type: /\S+/
      example: "eth0"

    - name: transport
      shortdesc: Corosync transport (mcast or udpu)
      default: "udpu"
      type: "udpu|mcast"

    - name: bindnetaddr
      shortdesc: Network address to bind to
      default: ""
      type: ipaddr
      example: 192.168.1.0

    - name: mcastaddr
      shortdesc: Multicast address
      default: ""
      type: ipaddr
      example: 239.x.x.x

    - name: mcastport
      shortdesc: Multicast port
      default: 5405
      type: 0-65535
  steps:
    - name: Configure SSH
      apply_local: configure.py ssh

    - name: Check state of nodes
      collect: collect.py

    - name: Verify parameters
      validate: verify.py

    - name: Install packages
      apply: configure.py install

    - name: Generate corosync authkey
      apply_local: authkey.py

    - name: Configure cluster nodes
      apply: configure.py corosync

    - name: Initialize cluster
      apply_local: init.py
